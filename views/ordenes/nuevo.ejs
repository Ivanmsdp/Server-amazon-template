<% include ../views_template_v2/dashboard_top %>

<!-- row -->
<div class="row tm-content-row tm-mt-big">
    <div class="col-lg-8 col-md-10 col-sm-12 offset-lg-2 offset-md-1">
        <div id="color_fondo" class="bg-light tm-block borde-curvo">
            <div class="input-group mb-3">
                <h3 class="text-center">Nueva Órden</h3>
                <div class="input-group">
                    <div class="col-lg-10 offset-lg-1">
                        <div class="form">
                            <div class="row">
                                <div class="col l12 m12 s12">
                                    <div class="input-field my-3">
                                        <input type="text" class="validate" id="nombre" required>
                                        <label for="nombre">Nombre</label>
                                    </div>
                                    <div class="input-field my-3">
                                        <input id="email" type="email" class="validate">
                                        <label for="email">Email</label>
                                    </div>
                                </div>
                                <div class="col l9 m6 s12">
                                    <div class="input-field my-3">
                                        <input type="text" class="form-control" id="nit" required>
                                        <label for="nit">NIT</label>
                                    </div>
                                </div>
                                <div class="col l3 m6 s12">
                                    <div class="input-field my-3">
                                        <input class="form-control" id="phone" name="phone" type="tel">
                                    </div>
                                </div>
                                <div class="input-group my-3">
                                    <input type="text" class="form-control" id="moneda" required value="GTQ" disabled>
                                    <label for="moneda"></label>
                                </div>
                            </div>

                            <h4 class="text-center">
                                Lista de Productos
                                <a class="waves-effect waves-light btn modal-trigger" href="#modal_agregar_item"><i
                                        class="material-icons">add</i><span class="icon-text"></span></a>

                            </h4>
                            <div class="table-responsive">

                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <th>Descripción</th>
                                        <th>tipo</th>
                                        <th>Precio Unitario</th>
                                        <th class="text-center"><i class="fas fa-cog"></i></th>
                                    </thead>
                                    <tbody id="tabla_items_agregados">
                                    </tbody>
                                </table>
                            </div>

                            <div class="row">
                                <div class="col s3 l8 text-right">
                                    <h4>Total</h4>
                                </div>
                                <div class="col s1 l2">
                                    <h4 class="input-group-text">GTQ</h4>
                                </div>
                                <div class="col s8 l2">
                                    <div class="input-group mb-3">
                                        <div class="input-group-append ml-auto">
                                            <h4 class="input-group-text text-right" id="precio_unitario_total">0.00</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row" id="orden_enviada" style="display: none;">
                                <div class="col-6">
                                    <a href="/ordenes/nuevo" class="btn btn-block btn-primary my-3"
                                        id="nueva_orden">Nueva Órden</a>
                                </div>
                                <div class="col-6">
                                    <a href="/ordenes/" class="btn btn-block btn-secondary my-3" id="ir_ordenes">Listado
                                        de Órdenes</a>
                                </div>

                            </div>
                            <button class="btn btn-success btn-block my-3" id="guardar">Guardar</button>
                        </div>
                        <h4 class="text-center" id="respuesta"></h4>
                    </div>
                    <hr>
                    <div class="col-lg-8 col-md-10 col-sm-12 offset-lg-2 offset-md-1">
                        <h3 class="text-center">Validar Nit</h3>
                        <iframe src="https://cdn.c.sat.gob.gt/rtu/consulta-cui-nit" frameborder="0" style="width: 100%; height: 870px;" scrolling="no"></iframe>
                    </div>

    
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal_agregar_item" class="modal modal-fixed-footer">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title text-center" id="exampleModalLabel">Agregar Producto/Servicio</h5>
        </div>
        <div class="modal-body">
            <div class="input-group mb-3">


                <div class="file-field input-field">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="boton_buscar"><i
                                class="material-icons">search</i></button>
                    </div>
                    <div class="file-path-wrapper">
                        <input type="text" class="form-control" id="campo_buscar" placeholder="Buscar Item"
                            aria-label="Buscar Item" aria-describedby="button-addon2">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <div class="col-12">
                    <div class="input-group" id="">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="">
                                <thead>
                                    <tr>
                                        <th class="text-center">Descripción</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Precio Unitario</th>
                                        <th class="text-center"><i class="fas fa-plus"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="lista_items">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <a class="modal-close waves-effect waves-green btn-flat">Cerrar</a>
    </div>
</div>
</div>

<% include ../views_template_v2/dashboard_bot %>

<script>
    var input = document.querySelector("#phone");
    window.intlTelInput(input, {
        // allowDropdown: false,
        // autoHideDialCode: false,
        // autoPlaceholder: "off",
        dropdownContainer: document.body,
        // excludeCountries: ["us"],
        // formatOnDisplay: false,
        // geoIpLookup: function (callback) {
        //    $.get("http://ipinfo.io", function () {}, "jsonp").always(function (resp) {
        //        var countryCode = (resp && resp.country) ? resp.country : "";
        //        callback(countryCode);
        //    });
        //},
        // hiddenInput: "full_number",
        // initialCountry: "auto",
        // localizedCountries: { 'de': 'Deutschland' },
        // nationalMode: false,
        // onlyCountries: ['us', 'gb', 'ch', 'ca', 'do'],
        // placeholderNumberType: "MOBILE",
        preferredCountries: ['gt', 'us'],
        separateDialCode: true,
        utilsScript: "https://cdndte.s3.amazonaws.com/javascripts/int_input/utils.js",
    });
</script>


<script>
    $(document).ready(function () {

        $('.modal').modal();

        console.log('YEY');
        var item_agregado = 0;

        function buscar_items() {
            let item = $('#campo_buscar').val();
            console.log(item);

            $.ajax({
                method: "GET",
                url: '/api/items/buscar/' + item,
                data: item,
                success: function (response) {
                    console.log(response);
                    $('#lista_items').html('')
                    for (let p = 0; p < response.length; p++) {
                        const item = response[p];
                        $('#lista_items').append(` <tr
    id="tr_${item_agregado}" value="${item._id}" list=${item_agregado}>
    <td>
        ${item.descripcion}
    </td>
    <td class="text-center">
        ${item.bs}
    </td>
    <td class="text-right">
        Q. ${item.precio_unitario.toFixed(2)}
    </td>
    <td class="text-center">
        <button class="btn btn-success agregar_item_${item._id}" id_item="${item._id}">
            <i class="material-icons">add</i>
        </button>
    </td>
    </tr>`)

                        $('.agregar_item_' + item._id).click(function () {
                            $('#tabla_items_agregados').append(`
    <tr class="tr_${item_agregado}" value="${item._id}">
        <td class="JSONfile" json='${JSON.stringify(item)}'>
            ${item.descripcion}
        </td>
        <td class="text-center">
            ${item.bs}
        </td>
        <td class="text-right">
            Q. <span class="p_unitario">${item.precio_unitario.toFixed(2)}</span>
        </td>
        <td class="text-right">
            <button list="${item_agregado}" class="btn red darken-1 eliminar_item"><i
                    class="material-icons">delete</i></button>
        </td>
    </tr>`);
                            $('.eliminar_item').click(function () {
                                console.log('se borró item');
                                let thislist = $(this).attr('list')
                                $('.tr_' + thislist).remove();
                                $('#total_items').text($(
                                    '.eliminar_item').length)
                                calcular_p_unitario()

                            })
                            item_agregado++
                            $('#total_items').text($('.eliminar_item')
                                .length)
                            $('.id_para_item').each(function () {
                                console.warn($(this).val())
                            })
                            calcular_p_unitario()

                        })
                    }
                },
                error: function () {
                    $('#lista_items').html(
                        '<p>Hubo un error en la búsqueda de items. Vuelve a intentarlo. </p>'
                    )
                }
            });

        }
        $('#boton_buscar').click(
            buscar_items
        )
        $('#campo_buscar').keyup(function (event) {
            if (event.key == 'Enter') {
                buscar_items()
            }
        })

        function calcular_p_unitario() {
            let total = 0
            $('.p_unitario').each(function () {
                total += parseFloat($(this).text())
                console.log(total);

            })
            $('#precio_unitario_total').text(parseFloat(total).toFixed(2))
        }

        $('#guardar').click(function () {
            let items = []
            $('.JSONfile').each(function () {
                const item = JSON.parse($(this).attr('json'))

                items.push(item)
            })

            const nit = $('#nit').val()
            const nombre = $('#nombre').val()
            let code = $('.iti__selected-dial-code').html()
            let phone = $('#phone').val()
            const telefono = code.substring(4, 1) + phone
            const email = $('#email').val()

            const fecha_emision = moment().unix()
            const moneda = $('#moneda').val()

            const total = parseFloat($('#precio_unitario_total').text())
            const orden = {
                nit,
                nombre,
                telefono,
                email,
                fecha_emision,
                moneda,
                items: JSON.stringify(items),
                total,
            }

            $.ajax({
                method: "POST",
                url: '/api/orden/',
                data: orden,
                success: function (response) {
                    console.log(response);

                    $('#respuesta').html('Orden Creada con Éxito.')
                    $('#color_fondo').removeClass('bg-light')
                    $('#color_fondo').removeClass('create_fail')
                    $('#color_fondo').addClass('create_success')
                    $('#guardar').hide()
                    $('#orden_enviada').show()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                    console.log(textStatus);
                    console.log(errorThrown);
                    $('#respuesta').html('Hubo un error, verificar campos')
                    $('#color_fondo').removeClass('bg-light')
                    $('#color_fondo').removeClass('create_success')
                    $('#color_fondo').addClass('create_fail')

                }
            })

        })

    });
</script>

<% include ../views_template_v2/dashboard_bot_2 %>